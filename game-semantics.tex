\newcommand{\invar}[1]{#1_{\mathrm{in}}}
\newcommand{\outvar}[1]{#1_{\mathrm{out}}}

\section{Game semantics}
\label{sec:game-semantics}

This section is devoted to the proof of Theorem~\ref{thm:single-use-closed}. To construct the function space $X \Rightarrow Y$, we use game semantics to identify a certain normal form of programs that compute single-use functions. The presentation in this section is self-contained, and does not assume any knowledge of game semantics. We base our notation on~\cite{abramsky2013semantics}.

Let us begin with a brief motivation for why game semantics will be useful.

While it is intuitively clear which functions should be allowed as single-use for simple types such as $\atoms \to 1+1$ or $\atoms \otimes \atoms \to \atoms + \atoms$, these intuitions start to falter when considering more complex types. After a certain point, it becomes more useful to give a more principled description of the intuition that pairs of type $X \otimes Y$ can be used on both coordinates, while pairs of type $X + Y$ can be used on a chosen coordinate only. The idea behind game semantics is to give the description in terms of an interaction between two players.  The two players are:
\begin{enumerate}
    \item System, represents the function (we will identify with this player); and
    \item Environment, who supplies inputs and requests outputs of the function.
\end{enumerate}
One of the intuitions behind the setup is that if a type $X \& Y$ appears in the input of the function, then it is the System who can choose the coordinate, while if the type appears in the output, then it is the Environment who makes the choice. (In this paper, we consider functions of first-order types of the form $X \to Y$, where $X$ and $Y$ are linear types that do not use $\otimes$, and therefore there will be a clear distinction between input and output values.)
Before giving a formal definition of game semantics, we give simple example of the interactions.

\begin{example}\label{ex:amp-otimes-distr}
    Consider the two types 
    \begin{align*}
        X \otimes (Y \& Z) 
        \quad \text{and} \quad
        (X \otimes Y) \& (X \otimes Z).
    \end{align*}
    We will explain why we can distribute in the direction $\rightarrow$, but not in the direction $\leftarrow$. 

    Let us first consider the interaction in the  direction $\rightarrow$. Player Environment begins be requesting an output. Since this output is of type $(X \otimes Y) \& (X \otimes Z)$, this means that Environment can choose to request either of the two types  $X \otimes Y$ and $X \otimes Z$. Suppose that Environment requests $X \otimes Y$. Now player System needs to react, and produce two elements: one of type $X$ and one of type $Y$. Both can be obtained from the input; for the second one player System can choose how to resolve the input $Y \& Z$ to get the appropriate value. 

    Consider now the interaction in the opposite direction $\leftarrow$. As we will see, player System will be unable to react to the behavior of player Environment, which will demonstrate that there is no distributivity in this direction. The problem is that player Environment can begin by requesting an element of type $X$, since the output type is $X \otimes (Y \& Z)$, while still reserving the possibility to request $Y \& Z$ in the future (because the tensor product $\otimes$ means that both output values need to be produced). To produce this element, player System will need  choose one of the two coordinates in the input type $(X \otimes Y) \& (X \otimes Z)$, and any of these two  choices will be premature, since player Environment can then request the opposite choice in the output type.  \exampleend
\end{example}

As explained in the above example, we will use a game to describe the possible behaviors of a function, as model as behaviors of player System. The game will be played in an arena, which will arise from the type of the function, and will tell us what are the possibilities for the moves of both players. 

We are now ready to outline the plan for the rest of this section. 
\begin{enumerate}
    \item For every two linear types $X$ and $Y$, we  define an arena, which is a data structure that describes all possible interactions between players Environment and System that can arise in single-use  functions of type $X \to Y$;
    \item In each arena, we will be interested in the strategies of player System, i.e.~the ways in which System reacts to moves of Environment. We show how such strategies can be interpreted as single-use functions: to each strategy we will assign a single-use function of type $X \to Y$ that is represented by this strategy. 
    \item We show that the  set of strategies in an arena is  large enough to represent all single-use functions, but small enough to be orbit-finite. 
    \item We then strengthen this: not only is the set of strategies orbit-finite, but it can be equipped with the structure of a linear type, such that both evaluation and currying will be single-use functions.
\end{enumerate}

The arenas from the first step in the plan will also be defined gradually. We begin by defining arenas and strategies for functions that do not use the structure of the atoms, i.e. constants and equality tests. This will be a fairly generic definition, almost identical to the classical game semantics for linear logic. Then we will extend the definition to cover the extra structure. 

\subsection{Arenas and strategies without constants and equality tests}
\label{sec:arenas-without-constants-and-equality-tests}

We begin with a simpler version of the game semantics, in which the arenas and strategies will describe functions that are not allowed to perform equality tests, and are not allowed to use constants. These strategies will model functions such as the identity function $\atoms \to \atoms$, but will not model the equality test $\atoms \otimes \atoms \to 1 + 1$, or the constant functions of type $1 \to \atoms$. The general idea is to use standard game semantics for linear logic, with an extra feature that we call \emph{register operations}. The register operations will be used to model the way in which atoms are passed from the input to output. For example, in the identity function,  Environment will  write the input atom into the register, and then player System will read the output atom from that register. The following definition of an arena is based on the definition from \cite[p.4]{abramsky2013semantics}, slightly
adapted for the context of this paper:
\begin{definition}[Arena] 
    An \emph{arena} consists of:
    \begin{enumerate}
        \item A set of \emph{moves}, with each move having an assigned owner, who is either ``System'' or ``Environment'', and one of three\footnote{\label{footnote:read-write} In all arenas that we consider, the ``read'' moves will be owned by System and the ``write'' moves will be owned by Environment. Therefore, we could simplify the register operations and have just one, called ``read/write'', whose status is determined by its owner. 
        } register operations, which are ``none'', ``read'', or ``write''.
                \item A set of plays, which a set of finite sequences of moves that is closed under prefixes, and such that in every play, the owner of the first move is Environment, and then the owners alternate.
    \end{enumerate}
\end{definition}




An arena will correspond to a type. The objects of that type, which will be  functions if the type is a functional type $X \to Y$, will be described by strategies in the arena. Such a strategy tells us how player System should react to the moves of player Environment. Intuitively speaking, in the case of a functional type, such a strategy will say how the function reacts to requests in the output type and values in the input type. We will only be talking about strategies for player System, so from now on, all strategies are going to be for player System. The following defintion corresponds to the definition from \cite[p.5]{abramsky2013semantics}:
%unless otherwise stated.
% In the above definition, the operations are a non-standard part of the arenas.  The idea is that the operations modify a memory store which has exactly one register, which contain a single atom or be empty.  A move that has an associated operation that is not ``none'' will be called an \emph{atom move}.


\begin{definition}[Strategy]
    A strategy  in an arena  is a subset of plays in the arena, which: 
    \begin{enumerate}
        \item is closed under prefixes;
        \item\label{item:sys-ext} if the strategy contains a play $p$ that ends with a move owned by player System, then it also contains all possible plays  in the arena that extend $p$ with one move of player Environment;
        \item\label{item:env-ext} if the strategy contains a play $p$ that ends with a move owned by player Environment, then it contains exactly one play  in the arena that extends $p$ with one move of player System;
        \item every ``read'' move is directly preceded by a ``write'' move (in particular a play cannot begin with ``read''), and every ``write'' move is either the last move, or directly succeeded by a ``read'' move;
        \item there is some $k$ such that all plays in the strategy have length at most $k$.
    \end{enumerate}
\end{definition}

The last condition will be appropriate in our context, since intuitively speaking our types are ``finite'', and there will be no need for unbounded computations. Conditions \ref{item:sys-ext} and \ref{item:env-ext} guarantee that the strategy only ``ends'' when 
Environment has no moves to play. 


We use the name \emph{immediate read condition} for the fourth condition in the above definition. This condition does not appear in the usual arenas from game semantics, since they do not have register operations. It ensures that there is matching between ``read'' and ``write'' moves in plays that do not end with write. Since ``write'' will always be owned by Environment, the immediate read condition will ensure a matching between ``write'' and ``read'' moves.
%in the plays that do not end with a move by player Environment, and such plays will be the most important ones. 

We will now show how to associate to each linear type a corresponding arena, and also how to associate an arena to a function type $X \to Y$. This definition will be compositional, i.e.~it will arise through operations on arenas that correspond to the type constructors such as $1$ or $\otimes$. The arenas that we will construct so far will not be our final proposal, since corresponding strategies will not be able to use constants or perform equality tests. This will be fixed in Section~\ref{sec:arenas-with-constants-and-equality-tests}, where a more complex arena will be defined for function types. Before giving formal definition, we begin with a simple example of the arena for the type $\atoms \to \atoms$.
\begin{example}\label{ex:identity-function-without-equality-tests-and-constants}
    We will define an arena for the type $\atoms \to \atoms$. In this arena, the only allowed function will be the identity function. This will be described by the following interaction between the two players: Environment  requests an output,  then System requests an input, then Environment grants the input, and finally player System grants the output by forwarding the input grant. In the arena that we will define, this will be the only possible interaction, but of course more complicated arenas will have more than one interaction. (In particular, our arena will only be able to describe the identity function, so it will need to be extended to cover single-use functions of type $\atoms \to \atoms$, such as constant functions.)

    The arena is shown in the following picture: 
    \mypic{6}
    The methodology of drawing this picture will become clearer later on, as we define operations on arenas such as $\otimes$. For the moment we describe the arena without caring that it arises as a special case of some general construction. The arena has four moves: 
    \begin{center}
        \begin{tabular}{lll}
         move & owner & register operation \\
            \hline
            request output & Environment & none \\
            request input & System & none \\
            grant input & Environment & write \\
            grant output & System & read 
        \end{tabular}    
    \end{center}
    The set of plays is defined as follows. These are all sequences that begin with a move of player Environment, alternative between players, use each move only once, and have the following condition:  ``grant output'' can only be played after ``request output'', and likewise for ``grant input'' and ``request input''.  

    A quick inspection of the above definition reveals that the arena has a unique maximal play, where the moves are played in the order from the table, and all other plays are prefixes of this maximal play. Because of the uniqueness of responses, the set of plays is also a strategy. As mentioned at the beginning of this example, the strategy describes the identity function.  \exampleend
\end{example}

We hope that the above example explains some intuitions about how arenas describe types and strategies describe functions. We now give a formal definition of arenas. This definition is compositional: we define arenas for the basic types $1$ and $\atoms$, and then we define operations on arenas that correspond to the type constructors  $+$, $\&$, and $\otimes$. We begin with the basic types.


\begin{definition}[Arenas for $1$ and $\atoms$]\label{def:arenas-without-atoms-or-functions} \ 
    \begin{enumerate}
        \item     The arena for the type $1$ is empty: there are no moves and the only play is the empty sequence. 
        \item The arena for type $\atoms$ has two moves, which must be played one after the other: first player Environment makes a move called ``request'' that has no register operation, and then player System responds with  a move called ``grant'' that has register operation ``read''.
    \end{enumerate}
\end{definition}

In the above definition, we only described the behavior of $\atoms$ when viewed as an output type. To get the input type, where the players are swapped and read is swapped with write, we will use duality, which is another operation on arenas. This operation, together with operations that correspond to the type constructors, are defined below.   

\begin{definition}[Operations on arenas]\label{def:composition-of-arenas}
    Let  $A$ and $B$ be arenas. We define the following arenas
        \begin{description}
            \item[$A+B$] The moves in this arena are the disjoint union of the moves of $A$ and $B$, with inherited owners and register operations, plus three extra moves: ``ask'' owned by Environment, and ``left'', ``right'' owned by System. 
            The plays are defined as follows. Player Environment begins with  an ask move, then System responds with a left or right move, and the remaining sequence is a play in the arena $A$ or $B$, depending on whether System chose left or right.
            \item[$A \& B$] The moves in this arena are the disjoint union of the moves of $A$ and $B$, with inherited owners and register operations, plus three extra moves: ``acknowledge'' owned by System, and ``left'', ``right'' owned by Environment. 
            The plays are defined as follows. Player Environment begins by choosing left or right, then player System responds with an acknowledge move, and the remaining sequence is a play  in the arena $A$ or $B$, depending on whether Environment chose left or right. (This construction differs slightly from the one from \cite[Excercise~1.10]{abramsky2013semantics} -- this is because we want to keep it analogous to the construction for $A + B$.)
            \item[$A \otimes B$] The moves in this arena are the disjoint union of the moves of $A$ and $B$, with inherited owners and register operations. A play in this arena is any shuffle of plays in the two arenas $A$ and $B$. (A shuffle of two words is any word obtained by interleaving them, e.g.~shuffles of ``car'' and ``boot'' include ``carboot'' and ``bcaoort'').
            By Definition~\ref{def:arenas-without-atoms-or-functions}, we require that the owners of the move alternate in the 
            interleaved sequences. (This construction is based on \cite[p.7]{abramsky2013semantics}.)
            \item[$\bar A$] This is called the dual arena of $A$. The moves and plays are the same as in $A$, except the owners are swapped, and the ``read'' and ``write'' register operations are swapped.
        \end{description} 
\end{definition}

Equipped with the above definitions, we  present our first attempt at assigning arenas to types. 

\begin{definition} Let $X$ and $Y$ be linear types.
    \begin{itemize}
        \item The \emph{arena for  $X$} is defined by inductively applying the constructions from Definition~\ref{def:arenas-without-atoms-or-functions} and Definition~\ref{def:composition-of-arenas} according to the library of $X$.
        \item The \emph{structure-less arena for $X \to Y$} is defined to be (dual of arena of $X$) $\otimes$ (arena of $Y$).
    \end{itemize}
\end{definition}

As discussed previously, our notion of arenas does not yet take into account the structure of the atoms, i.e.~the constants and equality tests. This will be fixed in the next section, by modifying the second item in the above definition (which is why we use the name \emph{structure-less} in the above definition, to distinguish it from the actual arenas for the function type that will take into account the structure of the atoms.)   On the other hand, the arenas from that first item in the above definition, for linear types without function types, are already in their final form. In principle the construction from the second item in the above definition can be nested, and thus used to assign arenas to higher order types that can nest $\to$ with the other type constructors. This is how it is usually done in linear logic. However,  the construction that we will describe in the next section will not be amenable to nesting, and it will only allow us to describe functions between types that do not use $\to$.


 

\begin{example}
    The arena for the identity type $\atoms \to \atoms$ is the same as the arena from Example~\ref{ex:identity-function-without-equality-tests-and-constants}.
\end{example}

\begin{example}
    (TODO) an arena for a more complicated type, for the benefit of readers unfamiliar with game semantics.
\end{example}




\subsection{Arenas and strategies with constants and equality tests}
\label{sec:arenas-with-constants-and-equality-tests}
In the Section~\ref{sec:arenas-without-constants-and-equality-tests}, we described arenas for functions that did not use the structure of the atoms, i.e.~constants and equality tests. We now show how these arenas can be extended to cover this structure. The general idea is to equip the arenas with an extra part that describes the allowed operations on the atoms. 



\begin{definition}[The library arena]\ 
    \begin{enumerate}
        \item The \emph{constant choice arena} is the following arena $\atoms+1$ moves:
        first player System chooses an atom, then player Environment plays move with register operation ``write''.
        \item The \emph{equality test arena} is an arena which the plays are as follows:
    \begin{enumerate}
        \item first player System plays a move with register operation ``read'';
        \item then player Environment plays an move with no register operation;
        \item then player System plays a move with register operation ``read'';
        \item then player Environment plays one of two moves, called $=$ and $\neq$, with no register operation.
    \end{enumerate}
    \todo{I think we should give names to all of the moves so that arena isoomorphism makes sense. }
    \item The \emph{library arena} is defined to be an arena that is obtained by applying $\otimes$ to infinitely many copies of the constant choice arena and infinitely many copies of the  equality test arena.
    \end{enumerate}
\end{definition}

The library arena is infinite. Taking the tensor product of infinitely many copies of the two arenas ensures that the library arena satisfies the following property, which corresponds to the $!$ operation from linear logic: 
\begin{align}\label{eq:bang-library-arena}
\text{library arena} 
\quad \equiv \quad 
\text{(constant choice arena)} \otimes 
\text{(equality test arena)} \otimes
 \text{(library arena)}.
\end{align}
In the above, $\equiv$ refers to isomorphism of arenas, which is defined in the natural way: this is a bijection between the moves, which is consistent with the owners, register operations and plays in the expected way.  Another property is that the library arena is isomorphic to a tensor product of itself: 
\begin{align}\label{eq:library-arena-isomorphism}
\text{library arena}
\quad \equiv \quad
\text{library arena} \otimes \text{library arena}.
\end{align}


We are now ready to give the final definition of arenas for functions between linear types, which take into account the structure of the atoms.

\begin{definition}[Arena for a function type] For linear types $X$ and $Y$, the arena of $X \to Y$ is 
    \begin{align*}
    \text{(library arena)} \otimes \text{(dual arena of $X$)} \otimes \text{(arena of $Y$)}.
    \end{align*}
\end{definition}

This completes the game semantics of linear types and functions between them. We do not intend to give game semantics for higher order types, such as functions on functions etc. As a result, we will only be using the dual once, namely for the arena of the input type. Also, note that the read/write operations will be used in a restricted way, as announced in Footnote~\ref{footnote:read-write}, namely that the ``read'' moves will be owned by System and the ``write'' moves will be owned by Environment.  This is because the library arena has this property, the arena for $\atoms$ has this property, and all operations on arenas that we have defined preserve this property.

\subsubsection{Composition of strategies}
\label{sec:composition-of-strategies}
One of the main points about strategies in game semantics is that they can be composed.
The usual construction for the function type $X \to Y$ is to take the tensor product of the dual arena for $X$ and the arena for $Y$. 

Our construction is a bit more involved, since the arena that we use has a copy of the library arena. We now explain how to compose strategies in a way that accounts for the library arena. 

We begin by describing the usual construction for composing strategies (as described in \cite[p.12]{abramsky2013semantics})
Let $A, B, C$ be arenas. Suppose that we have two strategies $\sigma$ and $\tau$, in the arenas $A \otimes \bar B$ and $B \otimes C$ respectively. These can be composed as strategy copying construction to get a new strategy in the arena $A \otimes C$
as ``shuffling plus hiding'', i.e. first we define the set $\sigma || \tau$ as the set of all shuffles of sequences in $\sigma$ 
and sequences $\tau$ (rember that strategies are subsets of sequences of moves), and then we define $\sigma; \tau$ as the 
sequences from $\sigma; \tau$, where all moves from $B$ (and $\bar{B}$) have been filtered out. Formally this is defined as follows:
\[ \begin{tabular}{l}
    $\sigma ; \tau = \{ s \restriction_{A, C} \ | \ s \in \sigma || \tau  \}$, where\\
    $\sigma || \tau = \{ s \in \textrm{moves}(A, B, C)^* \ | \ (s\restriction_{A, B}) \in \sigma \textrm{ and } (s\restriction_{B, C}) \in \tau \}$, and\\
    $s \restriction_{A, C}$ is equal to the sequence $s$ where all moves from $B$ have been filtered out. 
\end{tabular}
\]
Observe that $\sigma; \tau$ is a valid strategy. In particular,
if plays in $\sigma$ are bounded by $k$ and plays in $\tau$ are bounded by $l$,
then plays in $\sigma ; \tau$ are bounded by $k + l$. To show that this construction 
preserves the immediate read condition, let us consider two consecutive moves 
$m_e, m_s$ in a sequence from $\sigma;\tau$,
such that $m_e$ is a write move by the environment, 
and $m_s$ is the system's response, and let us show 
that $m_s$ is a read move. Since moves $m_e$ and $m_s$ are consecuive in 
$\sigma ; \tau$, it follows that in some sequence in $\sigma || \tau$, 
they are separated by some moves from $B$:
\[ \ldots m_e b_1 b_2 \ldots b_n m_s \ldots \quad \in \quad \sigma || \tau \]
Assume (w.l.o.g.) that $m_e$ belongs to $\sigma$.
Then, from definition of $\sigma || \tau$,
we know that $m_e$, $b_1$ is a consecutive pair of moves in (some sequence from) $\sigma$. 
It follows that $b_1$ is a read move in $\bar{A} \otimes B$,
which means that $b_1$ is a write move in $\bar{B} \otimes C$. 
By definition of $\sigma || \tau$, we know that $b_1, b_2$
are consecutive moves in $\tau$, which means that $b_2$ is 
a read-move in $\bar{B} \otimes C$, which in turn means that 
it is a write-move in $\bar{A} \otimes B$. By repeating this reasoning, 
we obtain that $b_n$ is a wite move in either $\bar{A} \otimes B$ or
$\bar{A} \otimes B$, which means that $m_s$ is a write move from that arena.
We can use the same reasoning to show that if $m_s$ is a read move, 
then $m_e$ has to be a write move.  


Now, let us show how to compose strategies that use the lirbary:
Consider three linear types $X, Y, Z$, and two strategies, in the arenas for $X \to Y$ and $Y \to Z$, respectively. 
By unfolding the definitions, these are strategies in the arenas 
\begin{align*}
\text{(library arena)} \otimes \overline{\text{arena for $X$}} \otimes \text{arena for $Y$} 
\qquad 
\text{(library arena)} \otimes \overline{\text{arena for $Y$}} \otimes \text{arena for $Z$}.
\end{align*}
We are using the strategy copying construction, we can combine them into a single  strategy in 
\begin{align*}
\text{(library arena)} \otimes  \text{(library arena)}\otimes \overline{\text{arena for $X$}} \otimes \text{arena for $Z$}.
\end{align*}
Since the library arena is isomorphic to a tensor product of two copies of itself, the above strategy gives us a strategy in the arena 
\begin{align*}
    \text{(library arena)} \otimes   \overline{\text{arena for $X$}} \otimes \text{arena for $Z$},
    \end{align*}
which is the arena for $X \to Y$. This strategy is defined to be the \emph{composition} of the original two  strategies. We write $\sigma; \tau$ for this composition. Thanks to \cite[Proposition~1.2]{abramsky2013semantics}, we know that the the usual
composition of library-free strategies is associative. It follows that our composition of library strategies is associative 
up to isomoprhism. 


\subsection{Strategies as single-use functions}
In this section, we explain how a strategy in a function type $X \to Y$ can be interpreted as a single-use function of the same type.
We start by showing how to interpret arenas of type $1 \to X$ as values of $\sem{X}$ and then we lift this interpretation to functions 
using stategy compositon. 
% This is done by interpreting values in the sets $\sem X$ and $\sem Y$ as strategies in the arenas $1 \to X$ and $1 \to Y$, respectively, and then lifting the interpretation to the function type using strategy composition. 




% \subsubsection{Elements of $\sem X$ as strategies in $1 \to X$}
% \label{sec:elements-of-sem-x-as-strategies-in-1-to-x}
% % We begin by interpreting the strategies in a linear type $1 \to X$ as elements of the underlying set $\sem X$.   
% % This will be done in two directions, as depicted in the following diagram.
% % \[
% % \begin{tikzcd}
% %     [column sep=6cm]
% % \text{strategies in the arena for $1 \to X$} 
% % \arrow[r, "{\text{to each strategy $\sigma$ we can associate an element $\sem \sigma \in \sem X$}}", from=1-1, to=1-2, start anchor=east, end anchor=west, bend left=10, shift right=-1ex, twoheadrightarrow]
% % &
% % \sem X
% % \arrow[l, "{\text{to each element $x \in \sem X$ we can associate a strategy $\sigma_x$}}", from=1-2, to=1-1, start anchor=west, end anchor=east, bend left=10, shift right=-1ex, rightarrowtail]
% % \end{tikzcd}
% % \]
% We begin by showing how an element of the underlying set in a type $X$ can be represented by some strategy in the arena for $1 \to X$. This is done by a straightforward induction on the structure of $X$, as described below. 

%     \begin{enumerate}
%         \item The strategy corresponding to the unique element of $1$ is the empty strategy.
%         \item The strategy corresponding to an atom $a \in \atoms$ is defined as follows: player Environment requests and output, then System requests the constant $a$ in the constant choice arena, Environment grants the constant, and System grants the output;
%         \item The strategy corresponding to $x_1 \otimes x_2$ is defined by composing the strategies corresponding to $x_1$ and $x_2$ in the natural way. The only point that we need to care about is the immediate read condition, so System needs to respond immediately in the same of the two arenas $X_1$ and $X_2$ when a write operation is played. 
%         \item The strategy corresponding to $x_1 \& x_2$ is defined as follows. In the first move, Environment chooses left or right, then System acknowledges this choice, and in the remaining game System plays according to the strategy for $x_1$ or $x_2$, depending on the first choice of player System.
%         \item Similarly, we define the strategy corresponding to $x_1 + x_2$.
%     \end{enumerate}

\subsubsection{Strategies in $1 \to X$ as elements of $\sem X$}
\label{sec:strategies-in-1-to-x-as-elements-of-sem-x}
We now describe the converse of the above construction, i.e.~we show how every strategy in the arena for $1 \to X$ can be interpreted as representing some value in $\sem X$. (For now we do not require that the transformation from strategies to values be single-use.)
Observe that we are not using the arena for a linear type $X$ itself, but for the function type $1 \to X$. The reason is that the second arena contains the library, which will be used to produce individual atoms. 
% This interpretation is more interesting than the previous one, since we need to account for suboptimal strategies of player System, in which the library arena is used to execute meaningless operations. For example, System might ask if atoms Mark and John are equal, and to make things worse, Environment might respond dishonestly that they are equal.  
% \begin{definition}
%     A strategy in an arena of type $X \to Y$ is called \emph{$k$-bounded} if all plays have length at most $k$. It is called \emph{bounded} if it is $k$-bounded for some $k$. 
% \end{definition}
% Formally, for every type $X$, we would like to define a function: 
% \[ \mathtt{val} : \textrm{(strategies in $1 \to X$)} \to X \]
% For this we are going to define inductively the following function: 
% \[ \mathtt{val'} :  \textrm{(strategies in $1 \to X_1 \otimes \ldots X_n$)} \times (\atoms + \bot)  \]

The general idea for the construction is that, given a strategy of system, we play an the environment to extract the value. 
Here are the details:
\begin{enumerate}
    \item For the type $1$ there is no difficulty, since the corresponding set has a unique element, which will be assigned to all strategies. Also, there is a unique play in the corresponding arena, which is $1 \to 1$. This unique play is  the empty play,  because player Environment cannot make a first move. Therefore, the assignment of values to strategies poses no difficulty, since there is one strategy and one value.  However, already at this stage there is a slightly subtle point, since the arena for $1 \to 1$ is not completely empty, because it  contains a copy of the library arena, however all moves in this arena are blocked, since they must begin with a move by player System, and player System cannot  move before Environment; this is similar to the ordre de préséance at Versailles.
    \item Consider now the type $\atoms$.  We will assign to each strategy in the arena for
    $1 \to \atoms$ an element of the underlying set $\atoms$.
    As we play as the environment, the first move belongs to us. 
    We use it to play ``request'' in $\atoms$ (this is the only move 
    available to the enviroment). Then we look at the response of the system according to the strategy.
    It has to be an atom move in the constant choice arena (the only other two moves 
    avaliable to the system are ``grant'' in in $\atoms$ and ``read'' in equality test, 
    however both of those are read moves, and they can only be played immediately after a 
    write move). We (i.e. the environment) respond with the write move in the constant choice arena. 
    At this point the system might decide to spend some time in the library requesting 
    for constants and comparing them to each other (this is a non-standard 
    behaviour, because the system should already know the results of constants comparisons). 
    While the system does this, we (i.e. the environment) simulate the library, granting the contants, and replying 
    to equality queries according to the equality of the requested constants.    
    Since the strategy of the system is bounded, it has to finish the game in $k$ moves, 
    so it will eventually have to play ``grant'' in $\atoms$ (beacuse only then enviroment will be left with no moves). 
    At this point we assign to the strategy, the most recent atomic constant requested by the system.

    % To define this atom, we will simply follow the strategy according to an honest behavior of player Environment, i.e.~where Environment gives correct answers to all equality tests. 
    
    % \begin{definition}
    %     A play in an arena of type $X \to Y$ is called \emph{honest} if all equality tests are answered correctly by player Environment. More formally, (...)
    % \end{definition}

    % One can see that for every strategy in the arena for $1 \to \atoms$, there is a unique maximal honest play that is consistent with this strategy. In this play, eventually System must execute the read operation on the atom, and the preceding write move necessarily had to be an atom constant (since these are the only write moves in the arena). This constant is defined to be the value of the strategy. 

    \item Now we show how to assign a value $\sem{X + Y} = \sem{X} + \sem{Y}$ to a strategy of type $1 \to X+Y$. We start by playing 
    ``ask''. The system can now, again, spend some time in the library requesting for constants and comparing them to 
    each other -- we simulate this by replying to equality tests according to the equality of constants. 
    Since the system is bounded it will eventually have to play either ``left'' or ``right''.
    If it plays ``left'', we obtain a strategy for $1 \to X$. We use induction to
    compute its value $v \in \sem{X}$ and we return $\text{left}(v)$. 
    If the system plays ``right'', the construciton is analogous. 

    \item Now we show how to compute $\sem{X \& Y} = \sem{X} \times \sem{Y}$ from the strategy $1 \to X \& Y$.
          This means that we need to construct two values: $x \in \sem{X}$ and $y \in \sem{Y}$.
          To compute $x \in X$, we start by playing ``left''. Then system might spend some time in the library -- 
          we deal with this as in the previous cases, but eventually it will have to play ``acknowledge''. 
          At this point we obtain a system's strategy for $1 \to X$, and again we use induction to comptue $x \in \sem{X}$.
          In order to compute $y \in Y$, we take the original strategy and play ``right'' instead. 


    \item Finally, we show how to compupute a value $\sem{X \otimes Y} = \sem{X} \times \sem{Y}$ from 
          the strategy $\sigma : 1 \to X \times Y$. We start by treating $\sigma$ as in strategy 
          in $1 \to X$ and use the inductive assumption to compute the value $x$.
          This is possible because if the environment never plays in $Y$, then 
          the system can never reply in $Y$ (due to the Versailles-like customs of the arenas).
          Then, we are left with a strategy that is effectively equivalent to a strategy
          in $1 \to Y$ (beacuse the $X$-part of $\sigma$ is already entirely played out), 
          so we can use the induction assumption to transform it into the valye $y \in Y$, 
          and return $(x, y) \in \sem{X} \times \sem{Y}$. 
\end{enumerate}



\subsubsection{Strategies in $X \to Y$ as single-use functions}
We now show how to interpret a strategy in the arena for $X \to Y$ as a single-use function of type $X \to Y$:
%This is done by putting together the operations that have been defined previously. 

\begin{definition}\label{def:strategy-as-single-use-function}
    Let $X$ and $Y$ be linear types. For a strategy $\sigma$ in the arena $X \to Y$,
    and a function $f : \sem{X} \to \sem{Y}$, we say that $\sem{\sigma} = f$ if for every strategy 
    $\nu_x : 1 \to X$, it holds that: 
    \[ \mathtt{val}_Y(\nu_x ; \sigma) = f(\mathtt{val}_X(\nu_x)) \textrm{,} \]
    where $\mathtt{val}_X$ is the mapping from strategies of type $1 \to X$ to elements of $\sem{X}$ 
    defined in Section~\ref{sec:strategies-in-1-to-x-as-elements-of-sem-x}.
    % the represented function  $\sem \sigma$ is defined to be the composition of the following three transformations:
    % \[
    % \begin{tikzcd}
    % \sem X  
    % \ar[d,"{\text{transformation defined in Section~\ref{sec:elements-of-sem-x-as-strategies-in-1-to-x}}}"] 
    %  \\ 
    % \text{strategies in arena for $1 \to X$}
    % \ar[d,"{\tau \mapsto \text{$\tau;\sigma$ as defined in Section~\ref{sec:composition-of-strategies}}}"] 
    % \\
    % \text{strategies in arena for $1 \to Y$}
    % \ar[d,"{\text{transformation defined in Section~\ref{sec:strategies-in-1-to-x-as-elements-of-sem-x}}}"] 
    % \\ 
    % \sem Y
    % \end{tikzcd}
    % \]
\end{definition}

We now show that the construction in the above definition is complete.
\begin{lemma}
    Let $X$ and $Y$ be linear types, then every single-use function of type $X \to Y$ is represented by at least one strategy. 
    % \begin{itemize}
    %     \item \emph{Soundness.} Every function represented by a strategy in the arena for $X \to Y$ is single-use.
    %     \item \emph{Completeness.} Every single-use function of type $X \to Y$ is represented by at least one strategy.
    % \end{itemize}
\end{lemma}
\begin{proof}
    It suffices to show that all single-use prime functions can be represented as strategies,
    and show how to raise combinators $\circ$, $\otimes$, $\times$, $\&$ from functions to 
    strategies in a way that preserves the semantics. Let us start with the combinators:
    \begin{description}
        \item[$f \circ g$] Here we use the construction for strategy composition from Section~\ref{sec:composition-of-strategies}.
        This means that we need to show that for all strategies $\sigma : X \to Y$ and $\tau: X \to Z$, 
        and for all functions $f : \sem{X} \to \sem{Y}$ and $g: \sem{Y} \to \sem{Z}$,
        if $\sem{sigma} = f$ and $\sem{tau} =g$, then $\sem{\sigma; \tau} = g \circ f$. By \ref{def:strategy-as-single-use-function}, 
        this means that we need to show that for all strategies $\nu : 1 \to X$, it holds that: 
        \[ \mathtt{val}(\nu; (\sigma; \tau)) = g(f(\mathtt{val}(\nu))) \]
        First, let us notice that (as explained in Section~\ref{sec:composition-of-strategies}) 
        the strategy $\nu; (\sigma; \tau)$ is equal to $(\nu; \sigma); \tau$ up to arena isomorphism. 
        Since area isomoprhisms preserve $\mathtt{val}$ (as they only rename library funcions), 
        we obtain that:
        \[ \mathtt{val}(\nu; (\sigma; \tau)) = \mathtt{val}((\nu; \sigma;) \tau) = g(\mathtt{val}(\nu; \sigma)) = g(f(\mathtt{val}(\nu))) \]

        \item[$f + g$] First, let us show how to construct a strategy $\sigma_1 + \sigma_2 : (X_1 + X_2) \to (Y_1 + Y_2)$ 
        from strategies $\sigma_1 : X_1 \to Y_1$ and $\sigma_2 : X_2 \to Y_2$. The strategies work as follows (remember that 
        now we play as system): The first move of environment has to be ``ask' (in $Y_1 + Y_2$), 
        we reply with ``ask'' in $X_1 + X_2$, then environment can only reply with either ``left'' or ``right''
        in $X_1 + X_2$ -- if it replies ``left'', we reply with ``left'' in $Y_1 + Y_2$ and contiune playing according to $\sigma_1$, 
        else we reply ``right'' and continue playing according to $\sigma_2$.
        For $\sigma_1 + \sigma_2$ defined in this way, it is not hard to see that if $\sem{\sigma_1} = f_1$ and $\sem{\sigma_2} = f_2$, 
        then $\sem{\sigma_1 + \sigma_2} = f + g$. This because by definition of strategy compsition, $\mathtt{val}$ and $+$, 
        we know that $\nu; (\sigma_1 + \sigma_2)$ is either equal to (a) $\nu'; \sigma_1$ for some $\nu'$ 
        such that $\mathtt{val}(\nu) = \mathtt{left}(\mathtt{val(\nu_1)})$, or
        $\nu'; \sigma_2$ for some $\nu'$  such that $\mathtt{val}(\nu) = \mathtt{right}(\mathtt{val(\nu')})$. 

        \item[$f \& g$] Here the construction is similar to the one for $+$: We strat by showing 
        how to construct a strategy $\sigma_1 + \sigma_2 : (X_1 \& X_2) \to (Y_1 \& Y_2)$ 
        $\sigma_1 : X_1 \to Y_1$ and $\sigma_2 : X_2 \to Y_2$: The first move of environment has to be either 
        ``left'' or ``right'' in $Y_1 \& Y_2$. We respond with the same in $X_1 \& X_2$. The only move of 
        the environment is now to ``acknowledge'' in $Y_1 \& Y_2$, after which we ``acknowledge'' in $X_1 \& X_2$. 
        Then we play either according to $\sigma_1$ or $\sigma_2$ (depending on whether the first move of the environment
        was ``left'' or ``right''). To see that if $\sem{\sigma_1} = f_1$ and $\sem{\sigma_2} = f_2$, then 
        $\sem{\sigma_1 \& \sigma_2} = f_1 \& f_2$, we notice that by definition of composition and $\&$, 
        we know that after environment plays ``left'' in $\nu; (\sigma_1 \& \sigma_2)$ the game proceeds 
        to a state equivalent to $\nu_1 ; \sigma_1$, where $\pi_1(\mathtt{val}(\nu)) = \mathtt{val}(\nu_1)$. 
        (and analogously for ``right'').

        \item[$f \otimes g$] Again, let us start by showing how to constructed
        $\sigma_1 \times \sigma_2 : (X_1 + X_2) \to (Y_1 + Y_2)$ from $\sigma_1 : X_1 \to Y_1$ and $\sigma_2 : X_2 \to Y_2$.
        The first move is by environment. It can either play in $Y_1$ or in $Y_2$. Let us assume that
        it plays in $Y_1$ (as the other case is summetrical). Then, we play according to 
        $\sigma_1$. As $\sigma_1$ is bounded, this means that after some interaction with $X_1$ and the library\footnote{
            It might be worth clarifying that during this time, if we play in $X_1$ the environment needs to respond
            immediately in $X_1$ and if we play in the library, the environment needs to respond immediately in the library, 
            as it has no other available moves. 
        }
        we will respond in $Y_1$. Then the environment can choose again if it wants to play in $Y_1$ or $Y_2$
        if it plays in $Y_1$ we play according to $\sigma_1$, and if it plays in $Y_2$ we play according to $\sigma_2$. 
        We continue in this fashion until the environment has no available moves in $Y_1$ or $Y_2$.
        To see that if $\sem{\sigma_1} = f_1$ and $\sem{\sigma_2} = f_2$, then
        $\sem{\sigma_1 \otimes \sigma_2} = f_1 \otimes f_2$. Let us observe that during the 
        $Y_1$-part of computing $\mathtt{val}(\nu; (f_1 \otimes f_2))$ the game looks exactly the 
        same as the game for computing $\mathtt{val}(\nu_{Y_1}; f_1)$, 
        where $\nu_{Y_1}$ is define as the plays subset of plays from $\nu$, where 
        environment never plays in $Y_2$. This is a strategy in $1 \to Y_1$, because if 
        the environment never plays in $Y_1$ then system cannot respond in $Y_1$. 
        It is not hard to see that $\mathtt{val}(\nu_{Y_1}) = \pi_1(\mathtt{val}(\nu))$. 
        It follows that during the $Y_1$-part of the play for computing $\mathtt{val}(\nu; (\sigma_1 \otimes \sigma_2))$, 
        we obtain $f_1(\pi_1(\mathtt{val}(\nu)))$. Similarly, one can show that during the $Y_2$ part of computing
        $\mathtt{val}(\nu; (\sigma_1 \otimes \sigma_2))$, we obtain $f_2(\pi_2(\mathtt{val}(\nu)))$. It follows that: 
        \[ \mathtt{val}(\nu; (\sigma_1 \otimes \sigma_2)) \quad = \quad \bigl( f_1(\pi_1(\mathtt{val}(\nu))),\ f_2(\pi_2(\mathtt{val}(\nu))) \bigr) \quad = \quad (f_1 \otimes f_2) (\mathtt{val}(\nu))\]
    \end{description}
    Let us now deal with prime functions. For the sake of brevity we only show how to implement them 
    for the following representative set of examples (all of the prime functions not listed below, 
    can be implemneted without ever playing the library, and are well known tautoligies of the affine logic):
    \begin{description}
        \item[$\textrm{eq} : \atoms \otimes \atoms \to 1 + 1$]:
        For this funcion the system wants to call the library function for comparing atoms 
        and return the result. Here is the exact strategy:    
        First, the environment has to play ``ask'' in $1+1$. Then we play ``request'' in the left $\atoms$.
        Environment replies with ``grant'' which is a write move. Then we play the read 
        move in atoms equality library function. Environment acknowledges. We play ``request'' in the 
        right $\atoms$. Environment plays ``grant''. We play the read move in the atoms equality function. 
        The environment replies with either $=$ or $\neq$, to which we respond respectively with ``left''
        or ``right'' in $1+1$.

        \item[$\textrm{const}_a : 1 \to \atoms$] For this function we want to call the constant
        functionality of the library. Here is the exact strategy: First, the environment has to play 
        ``request'' in $\atoms$. We respond in the $a$-move in the constant library component. 
        The environment has to respond with the write move, we respond with ``grant''. 

        \item[$\textrm{proj}_1 : X \otimes Y \to X$] Here we play a restricted version of the copycat strategy:
        whenever the environment plays in the right copy of $X$, we play the same move in he left copy of $X$, 
        and whenever the environment responds in the left copy of $X$, we respond with the same move in the right 
        copy of $X$. 

        \item[$\textrm{distr}_{\&, \otimes} : X \otimes (Y \& Z) \to (X \otimes Y) \& (X \otimes Z)$]
        Here we play according to the strategy from \ref{ex:amp-otimes-distr}: The environment 
        starts by either playin ``left'' or ``right'' in $(X \otimes Y) \& (X \otimes Z)$, 
        we respond with the same move in $(Y \& Z)$. The environment has to play ``acknowledge'' 
        in $(Y \& Z)$, after which we play acknowledge. This leaves in a state that is either 
        equivalent to $X \otimes Y \to X \times Y$ or  $X \otimes Z \to X \times Z$. 
        In both cases we play according to the copycat strategy.  \todo{Define copycat?}
    \end{description}
\end{proof}
One can also show that the system is sound (i.e. that every function repersented by a strategy is single-use). \todo{reference 
to a claim, which follows from SMCC-ness. We don't defer the proof of completeness because the proof of SMCC-ness depends on it.}

\subsection{The set of strategies as a linear type}
The purpose of this section is to show that the set of strategies in an arena for a function type $X \to Y$ can be described using some linear type, and furthermore the relevant operations on strategies, such as application and currying, can be performed in a single-use way. 

In the definition of the linear type, we will be only interested in certain strategies, which avoid behavior that is not relevant to the computation.

\begin{definition}[Irrelevant question] We say that a play in an arena for $X \to Y$ contains an \emph{irrelevant question} if it contains an equality test on two constants. We say that this strategy \emph{does not ask irrelevant questions} if none of its plays have irrelevant questions.
\end{definition}
  
The following lemma shows that if irrelevant questions are disallowed, then plays have length bounded by some constant that depends only on the types involved. This will be one of the useful properties of such strategies, since it will allow us to represent them using a finite linear type.

\begin{lemma}\label{lem:no-irrelevant-questions-are-bounded}
    For every linear types $X$ and $Y$ there is some $k$ such that if a strategy in the arena for $X \to Y$ does not ask irrelevant questions, then all plays in the strategy have length at most $k$.
\end{lemma}

There is a subtle point, which is illustrated in the following example:  strategies that do not ask irrelevant questions are not closed under composition. 

\begin{example}[irrelevant questions from composition]
    Consider the  following two functions: 
    \begin{enumerate}
        \item the function of type  $1 \to \atoms \otimes \atoms$ that outputs the pair (Mark, John) for its unique input;
        \item the equality test of type $\atoms \otimes \atoms \to 1 + 1$.
    \end{enumerate}
    Like all single-use functions, the above two functions can be represented using strategies that do not ask irrelevant questions. However, if we apply the composition construction from Section~\ref{sec:composition-of-strategies} to these two strategies, we will get a strategy that asks the irrelevant question of whether Mark and John are equal. \exampleend
\end{example}

In light of the above example, we will want to eliminate irrelevant questions. 

\begin{lemma}\label{lem:eliminate-irrelevant-questions}
    For every linear types $X$ and $Y$, every single-use function of type  $X \to Y$ is represented by  some strategy that does not ask irrelevant questions.
\end{lemma}


The following lemma shows that the set of $k$-bounded strategies can be described using a linear type.

\begin{lemma}\label{lem:linear-type-of-k-bounded-strategies}
    Let $X$ and $Y$ be linear types, and let $k \in \set{0,1,\ldots}$. One can find: 
    \begin{enumerate}
        \item \label{it:k-bounded-type} a linear type, call it $X \Rightarrow_k Y$;
        \item \label{it:k-bounded-bijection} a bijection of its underlying set with the set of $k$-bounded strategies in the arena for $X \to Y$;
        \item \label{it:k-bounded-eval} a single-use function of type $X \otimes (X \Rightarrow_k Y) \to Y$;\end{enumerate}
    such that for every $k$-bounded strategy $\sigma$, the following diagram commutes:
    \[
    \begin{tikzcd}[column sep=3.5cm]
    X  
    \ar[rr,"{x \mapsto x \otimes \text{(element corresponding to $\sigma$ via bijection in item~\ref{it:k-bounded-bijection}})}"]
    \ar[dr,"{\text{function represented by $\sigma$}}"']
    & & 
    X \otimes (X \Rightarrow_k Y)
    \ar[dl,"\text{function from item~\ref{it:k-bounded-eval}}"]
    \\
    & Y
    \end{tikzcd}
    \]    
\end{lemma}




\begin{proof}[Proof of Theorem~\ref{thm:single-use-closed}]
    Consider two types $X$ and $Y$.
 Take $k$ to be the number from Lemma~\ref{lem:no-irrelevant-questions-are-bounded}. This ensures that the type $X \Rightarrow_k Y$ is rich enough to represent all strategies that do not ask irrelevant questions. By Lemma~\ref{lem:eliminate-irrelevant-questions} the type is  rich enough to represent all single-use functions. Define the  function space $X \Rightarrow Y$ to be this type.   Define the evaluation function 
    \begin{align*}
    \text{eval} : X \otimes (X \Rightarrow Y) \to Y 
    \end{align*}
    to be the evaluation function in item~\ref{it:k-bounded-eval} in Lemma~\ref{lem:linear-type-of-k-bounded-strategies}. We will now prove that this type admits currying. Consider then some single use function 
    \begin{align*}
    f : Z \otimes X \to Y.
    \end{align*}
    By Lemma~\ref{lem:bounded-k}, there is some $\ell$ such that $f$ is represented by some  $\ell$-bounded strategy $\sigma$ in the game of type $Z \otimes X \to Y$. For strategies, there is a straightforward notion of currying, which is single-use, as given in the following claim.

    \begin{claim}
        Let $X$, $Y$, and $Z$ be linear types, and let $\ell \in \set{0,1,\ldots}$. For every $\ell$-bounded strategy $\sigma$ in the game  of type $Z \otimes X \to Y$  there is a single-use function $\Lambda : Z \to (X \Rightarrow_\ell Y)$, such that the following diagram commutes:
        \[
        \begin{tikzcd}
            [column sep=3.5cm]
        X
        \ar[r, "{x \mapsto z \otimes x}"]
        \ar[dr, "\text{strategy represented by $\Lambda(z)$}"']
        &
        Z \otimes X 
        \ar[d, "{\text{strategy represented by $\sigma$}}"] \\
        &
        Y
        \end{tikzcd}
        \]
        \end{claim}
        The currying operation from the above claim gives us almost the currying that is required in Theorem~\ref{thm:single-use-closed}. The only issue is that the output is in $X \Rightarrow_\ell Y$, where the number $\ell$ depends also on the extra set $Z$, instead of $X \Rightarrow_k Y$. To fix this, we post-compose it with the single-use function from $X \Rightarrow_\ell Y$ to $X \Rightarrow_k Y$  that was described in the remarks after Lemma~\ref{lem:bounded-k}. 
    

\end{proof}